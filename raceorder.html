
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Team Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        th.sortable { cursor: pointer; }
        th.sortable:hover { background-color: #f3f4f6; }
	th.sortable::after {
    		content: ' â†•';
    		opacity: 0.3;
    		font-size: 0.8em;
	}
        .shuffle-animation { animation: pulse 0.3s ease-in-out; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); background-color: #4f46e5; }
        }
@media print {
	body { font-size: 10px !important; }
	.p-8,
	.p-4,
	.md:p-8,
	.p-6
	 { padding: initial !important; }
	.shadow-xl { box-shadow: none !important; }
	.border-slate-200 { border: none !important; }
}
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 text-slate-800 font-sans">
    <div class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
        <header class="mb-8 border-b pb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">Race Team Generator</h1>
                <p class="text-slate-500 print:hidden">Stratified age balancing into capped size "sub-team" team blocks, mathematically placed into equitable 3 race run orders by sub-team.</p>
            </div>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print:hidden">
            <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1"><strong>1)</strong> Max Athletes per Sub-Team</label>
                    <small>Teams will be split into sub-teams that don't exceed this size. Bigger results in more "static penalty" for the racers at the end of each sub-team and smaller results in more complex bib orders for the 3rd run in order to balance the start orders. 12 is suggested as a starting point since it aligns with the suggested course slip frequency.</small>
                    <input type="number" id="maxSize" value="12" min="1" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                </div>
                <div class="flex items-center gap-3 p-2 bg-white rounded-lg border shadow-sm">
                    <input type="checkbox" id="shuffleToggle" class="w-5 h-5 cursor-pointer accent-blue-600" checked>
                    <label for="shuffleToggle" class="text-sm font-semibold cursor-pointer select-none"><strong>2)</strong> Randomize within Age Groups</label>
                </div>
                    <small>If the input start list is ordered (e.x., sorted by athlete name alphabetically) you can check this to randomize the sub-team assignment). If athletes were pre-seeded, uncheck this box.</small>
            </div>

            <div class="md:col-span-2 border-2 border-dashed border-blue-200 rounded-xl p-4 flex items-center justify-center bg-blue-50/50 hover:bg-blue-100 transition-all group">
                <input type="file" id="csvFile" accept=".csv" class="hidden" />
                <label for="csvFile" class="cursor-pointer text-center">
                    <div class="text-blue-700 font-bold text-lg group-hover:scale-105 transition-transform"><strong>3)</strong> Click to Select CSV</div>
                    <p class="text-s text-slate-400 mt-1">Required columns: name, age_class, club_name</p>
                </label>
            </div>
        </div>

        <div id="resultsArea" class="hidden space-y-10 animate-in fade-in duration-500">
            <section class="bg-indigo-900 p-6 rounded-xl shadow-xl text-white">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-indigo-300 flex items-center gap-2"><span>ðŸŽ²</span> Race Draw & Sequence</h3>
                    <div class="flex gap-2 print:hidden">
                        <button id="resetDrawBtn" class="bg-indigo-800 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-xs font-bold transition border border-indigo-600">Reset to A-Z</button>
                        <button id="shuffleClubsBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition border border-indigo-500">Shuffle Clubs</button>
                        <button id="shuffleDrawBtn" class="bg-indigo-500 hover:bg-indigo-400 text-white px-4 py-2 rounded-lg text-xs font-bold transition border border-indigo-400">Shuffle All Sub-Teams</button>
                    </div>
                </div>
			<small class="print:hidden">If using "Shuffle Clubs," I recommend to "Shuffle Clubs" until a team isn't split across the start and end for Run 2. <em>(This should emphasize for you how hard it is to slice big blocks of teams into equitable start orders if we want to avoid splitting up the team--it only works when a small team is in "the middle" of the initial race order and has the right balance of other teams adjacent to it.)</em></small>
                <div id="drawList" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-3 gap-3 text-sm font-mono"></div>
            </section>

            <section>
            <div id="summaryStats" class="hidden bg-blue-50 px-4 py-2 rounded-lg border border-blue-100 text-blue-800 text-sm font-bold"></div>
            </section>

            <section>
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h3 class="text-xl font-bold text-slate-800">Master Roster Preview</h3>
                    <button id="reloadBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-6 py-2.5 rounded-full font-bold transition active:scale-95 print:hidden">Start Over</button>
                    <button id="downloadBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-2.5 rounded-full font-bold shadow-lg transition transform active:scale-95 print:hidden">Download Roster CSV</button>
                </div>
                <div class="overflow-x-auto border rounded-xl shadow-sm bg-white">
                    <table id="rosterTable" class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="sortable px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-column="bib">Bib</th>
                                <th class="sortable px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-column="run2_pos">Race 2</th>
                                <th class="sortable px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-column="run3_pos">Race 3</th>
                                <th class="sortable px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-column="name">Athlete</th>
                                <th class="sortable px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-column="age_class">Age Class</th>
                                <th class="sortable px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-column="club_name">Club</th>
                                <th class="sortable px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-column="sub_team">Sub-Team</th>
				<th class="px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-column="start_sum">Start Seed Sum</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody" class="divide-y divide-slate-100 text-sm font-medium"></tbody>
                    </table>
                </div>
            </section>
        </div>
<div id="validationArea"></div>
    </div>

    <script>
// --- STATE MANAGEMENT ---
let processedData = [];
let currentUniqueTeams = [];
let manualSortActive = false; // Flag to check if user clicked a table header
let currentSortCol = null;
let sortDirection = 1;

// --- UTILITY ---
function getVal(row, possibleNames) {
    const key = Object.keys(row).find(k => 
        possibleNames.includes(k.toLowerCase().replace(/[^a-z0-9]/g, ''))
    );
    return row[key] || "";
}

function shuffle(array) {
    let m = array.length, t, i;
    while (m) {
        i = Math.floor(Math.random() * m--);
        t = array[m]; array[m] = array[i]; array[i] = t;
    }
    return array;
}

// --- FILE HANDLING ---
document.getElementById('csvFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const maxSize = parseInt(document.getElementById('maxSize').value) || 12;
    const shouldShuffle = document.getElementById('shuffleToggle').checked;
    if (!file) return;
    Papa.parse(file, {
        header: true, skipEmptyLines: true,
        complete: function(results) { processAthletes(results.data, maxSize, shouldShuffle); }
    });
});

function processAthletes(data, maxSize, shouldShuffle) {
    const clubs = {};
    data.forEach(row => {
        const club = getVal(row, ['club', 'clubname', 'team', 'club_name']) || "Independent";
        if (!clubs[club]) clubs[club] = [];
        clubs[club].push(row);
    });
    const sortedClubNames = Object.keys(clubs).sort((a, b) => a.localeCompare(b));
    processedData = [];
    const teamCounts = {};
    const uniqueNames = [];
    sortedClubNames.forEach(clubName => {
        const athletes = clubs[clubName];
        const numSubteams = Math.ceil(athletes.length / maxSize);
        for(let i=1; i<=numSubteams; i++) {
            const label = `${clubName} - Team ${i}`;
            uniqueNames.push(label);
            teamCounts[label] = 0;
        }
        const ageBuckets = {};
        athletes.forEach(a => {
            const age = getVal(a, ['age', 'ageclass', 'class', 'age_class']);
            if (!ageBuckets[age]) ageBuckets[age] = [];
            ageBuckets[age].push(a);
        });
/*
        Object.keys(ageBuckets).sort().forEach(ageKey => {
            let bucket = shouldShuffle ? shuffle([...ageBuckets[ageKey]]) : ageBuckets[ageKey];
            bucket.forEach((athlete, idx) => {
                const subTeamNumber = (idx % numSubteams) + 1;
                const subTeamLabel = `${clubName} - Team ${subTeamNumber}`;
                teamCounts[subTeamLabel]++;
                processedData.push({
                    bib: 0, run2_pos: 0, run3_pos: 0,
                    name: getVal(athlete, ['name', 'athlete', 'athletename', 'athlete name']),
                    age_class: ageKey, club_name: clubName, sub_team: subTeamLabel,
                    internal_rank: teamCounts[subTeamLabel]
                });
            });
        });
*/
// Track a global index for THIS club across all age groups
        let clubAthleteIndex = 0; 

        Object.keys(ageBuckets).sort().forEach(ageKey => {
            let bucket = shouldShuffle ? shuffle([...ageBuckets[ageKey]]) : ageBuckets[ageKey];
            
            bucket.forEach((athlete) => {
                // Use clubAthleteIndex instead of the local bucket 'idx'
                const subTeamNumber = (clubAthleteIndex % numSubteams) + 1;
                const subTeamLabel = `${clubName} - Team ${subTeamNumber}`;
                
                teamCounts[subTeamLabel]++;
                processedData.push({
                    bib: 0, run2_pos: 0, run3_pos: 0,
                    name: getVal(athlete, ['name', 'athlete', 'athletename', 'athlete name']),
                    age_class: ageKey, club_name: clubName, sub_team: subTeamLabel,
                    internal_rank: teamCounts[subTeamLabel]
                });
                
                clubAthleteIndex++; // Increment so the next athlete goes to the next sub-team
            });
        });
    });
    currentUniqueTeams = uniqueNames.map(name => ({ name }));
    updateRacePositions();
    disableControls();
}

function updateRacePositions() {
    const T = currentUniqueTeams.length;
    if (T === 0) return;

    const teamRankMap = new Map();
    const run1 = Array.from({length: T}, (_, i) => i);
    const shift = Math.floor(T / 2) + 1;
    const run2 = run1.map(i => (i + shift) % T);
    
    const run3Weights = run1.map((pos1, i) => {
        const pos2 = run2[i];
        return -(pos1 + pos2); 
    });

    const run3Indices = Array.from({length: T}, (_, i) => i);
    run3Indices.sort((a, b) => run3Weights[a] - run3Weights[b]);
    
    const run3 = new Array(T);
    run3Indices.forEach((originalIdx, sortedPos) => {
        run3[originalIdx] = sortedPos;
    });

    currentUniqueTeams.forEach((team, idx) => {
        teamRankMap.set(team.name, {
            r1: run1[idx] + 1,
            r2: run2[idx] + 1,
            r3: run3[idx] + 1
        });
    });

    const athletesByTeam = {};
    processedData.forEach(p => {
        if (!athletesByTeam[p.sub_team]) athletesByTeam[p.sub_team] = [];
        athletesByTeam[p.sub_team].push(p);
    });

    const finalize = (key, targetKey) => {
        const sortedTeams = [...currentUniqueTeams].sort((a, b) => 
            teamRankMap.get(a.name)[key] - teamRankMap.get(b.name)[key]
        );
        let athleteCounter = 1;
        sortedTeams.forEach((team, teamOrderIdx) => {
            const teamStartPos = teamOrderIdx + 1;
            teamRankMap.get(team.name)[targetKey + '_team_seed'] = teamStartPos;
            athletesByTeam[team.name].forEach(athlete => {
                athlete[targetKey] = athleteCounter++;
            });
        });
    };

    finalize('r1', 'bib');
    finalize('r2', 'run2_pos');
    finalize('r3', 'run3_pos');
    renderUI(teamRankMap);
}

function renderUI(teamRankMap) {
    document.getElementById('resultsArea').classList.remove('hidden');
    const counts = processedData.reduce((acc, curr) => {
        acc[curr.sub_team] = (acc[curr.sub_team] || 0) + 1;
        return acc;
    }, {});

    let rows = "";
    currentUniqueTeams.forEach(t => {
        const d = teamRankMap.get(t.name);
        const s1 = d.bib_team_seed;
        const s2 = d.run2_pos_team_seed;
        const s3 = d.run3_pos_team_seed;
        const sum = s1 + s2 + s3;
        rows += `
            <tr class="border-b border-slate-800">
                <td class="p-2 font-bold text-slate-100">${t.name} <span class="text-slate-500 font-normal">(${counts[t.name] || 0})</span></td>
                <td class="p-2 text-center">${s1}</td>
                <td class="p-2 text-center">${s2}</td>
                <td class="p-2 text-center">${s3}</td>
                <td class="p-2 bg-slate-800 text-center font-bold text-orange-400">${sum}</td>
            </tr>`;
    });

    document.getElementById('validationArea').innerHTML = `
        <div class="mt-8 bg-slate-900 p-6 rounded-xl border border-slate-700">
            <h3 class="text-white font-bold mb-2 italic text-sm">Team Start Order Summary</h3>
            <table class="w-full text-xs text-slate-300">
                <thead><tr class="border-b border-slate-700 text-center"><th class="text-left p-2">Team Name (Count)</th><th>Run 1 Seed</th><th>Run 2 Seed</th><th>Run 3 Seed</th><th>Team Start Seed Sum</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>`;

    const drawList = document.getElementById('drawList');
    const keys = ["bib_team_seed", "run2_pos_team_seed", "run3_pos_team_seed"];
    drawList.innerHTML = ["Run 1 Order", "Run 2 Order", "Run 3 Order"].map((label, i) => {
        const sorted = [...currentUniqueTeams].sort((a,b) => teamRankMap.get(a.name)[keys[i]] - teamRankMap.get(b.name)[keys[i]]);
        return `
            <div class="bg-indigo-950/50 p-4 rounded-xl border border-indigo-500/30">
                <h4 class="text-[14px] font-black uppercase text-indigo-300 mb-3">${label}</h4>
                <div class="space-y-1">
                    ${sorted.map((t, idx) => `
                        <div class="flex justify-between text-[11px] py-1 px-2 bg-indigo-900/40 rounded">
                            <span class="text-indigo-400 font-bold">${idx + 1}</span>
                            <span class="truncate ml-2 text-white">${t.name}</span>
                            <span class="text-indigo-300/50 ml-1 text-[14px]">(${counts[t.name] || 0})</span>
                        </div>`).join('')}
                </div>
            </div>`;
    }).join('');

    renderTable();
    updateSummaryStats();
}

function renderTable() {
    // 1. Calculate the start_sum for all rows before any sorting happens
    processedData.forEach(row => {
        row.start_sum = (row.bib || 0) + (row.run2_pos || 0) + (row.run3_pos || 0);
    });

    // 2. Default to bib order if the user hasn't clicked a header
    if (!manualSortActive) {
        processedData.sort((a, b) => a.bib - b.bib);
    }

    document.getElementById('previewBody').innerHTML = processedData.map(row => `
        <tr class="border-b text-xs hover:bg-slate-50">
            <td class="px-4 py-2 font-bold text-blue-600">${row.bib}</td>
            <td class="px-4 py-2 text-slate-500">${row.run2_pos}</td>
            <td class="px-4 py-2 text-slate-500">${row.run3_pos}</td>
            <td class="px-4 py-2">${row.name}</td>
            <td class="px-4 py-2">${row.age_class}</td>
            <td class="px-4 py-2">${row.club_name}</td>
            <td class="px-4 py-2 font-bold">${row.sub_team}</td>
            <td class="px-4 py-2 font-mono bg-slate-50 text-slate-700 font-bold">${row.start_sum}</td>
        </tr>`).join('');
}


function updateSummaryStats() {
    const statsDiv = document.getElementById('summaryStats');
    if (processedData.length === 0) return;

    const ages = [...new Set(processedData.map(a => a.age_class))].sort();
    let html = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 pb-2">`;
    
    ages.forEach(age => {
        const group = processedData.filter(a => a.age_class === age);
        const count = group.length;
        
        // Calculate the average of the combined start seeds
        const avgSum = (group.reduce((sum, a) => sum + (a.start_sum || 0), 0) / count).toFixed(1);

        html += `
            <div class="border-l-4 border-emerald-500 pl-3">
                <div class="text-xs uppercase text-emerald-700 font-black">${age} (${count} Racers)</div>
                <div class="text-[14px] text-slate-700">
                    Average start seed sum of field: <span class="font-bold">${avgSum}</span>
                </div>
            </div>`;
    });

    html += `</div>`;
    statsDiv.innerHTML = html;
    statsDiv.classList.remove('hidden');
}

function disableControls() {
    const controls = ['maxSize', 'shuffleToggle', 'csvFile'];
    controls.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.disabled = true;
            // Optional: Add a visual cue that they are locked
            el.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
        }
    });
    // Specifically handle the file label since it's a styled div
    const fileLabel = document.querySelector('label[for="csvFile"]');
    if (fileLabel) fileLabel.classList.add('cursor-not-allowed');
}

// --- BUTTON LISTENERS ---
document.getElementById('downloadBtn').addEventListener('click', () => {
    const csv = Papa.unparse(processedData);
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "race_draw.csv"; a.click();
});

document.getElementById('resetDrawBtn').addEventListener('click', () => { 
    manualSortActive = false; 
    currentUniqueTeams.sort((a, b) => a.name.localeCompare(b.name)); 
    updateRacePositions(); 
});

document.getElementById('shuffleDrawBtn').addEventListener('click', () => { 
    manualSortActive = false; 
    currentUniqueTeams = shuffle([...currentUniqueTeams]); 
    updateRacePositions(); 
});

document.getElementById('shuffleClubsBtn').addEventListener('click', () => {
    manualSortActive = false;
    const groups = {};
    currentUniqueTeams.forEach(team => {
        const clubName = team.name.split(' - Team')[0];
        if (!groups[clubName]) groups[clubName] = [];
        groups[clubName].push(team);
    });
    Object.keys(groups).forEach(club => {
        groups[club].sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
    });
    const shuffledClubNames = shuffle(Object.keys(groups));
    const newOrder = [];
    shuffledClubNames.forEach(club => {
        groups[club].forEach(team => newOrder.push(team));
    });
    currentUniqueTeams = newOrder;
    updateRacePositions();
});

document.getElementById('reloadBtn').addEventListener('click', () => {
    // Simply reloading the location is the safest way to reset all 
    // internal arrays, file inputs, and UI states.
    window.location.reload();
});

// --- TABLE SORTING LISTENER ---
/*
document.querySelectorAll('th.sortable').forEach(header => {
   sortDirection = -1; // default to ascending sort
    header.addEventListener('click', () => {
        const column = header.getAttribute('data-column');
        manualSortActive = true; 
        sortDirection *= -1; 

        processedData.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            if (typeof valA === 'number') return (valA - valB) * sortDirection;
            return valA.toString().localeCompare(valB.toString()) * sortDirection;
        });
        renderTable(); 
    });
});
*/
document.querySelectorAll('th.sortable').forEach(header => {
    header.addEventListener('click', () => {
        const column = header.getAttribute('data-column');
        manualSortActive = true;

        // If clicking a NEW column, force Ascending (1)
        // If clicking the SAME column, toggle the direction
        if (column !== currentSortCol) {
            sortDirection = 1;
            currentSortCol = column;
        } else {
            sortDirection *= -1;
        }

        processedData.sort((a, b) => {
            let valA = a[column] ?? "";
            let valB = b[column] ?? "";

            if (typeof valA === 'number') {
                return (valA - valB) * sortDirection;
            } else {
                return valA.toString().localeCompare(valB.toString()) * sortDirection;
            }
        });

        renderTable();
    });
});
    </script>
</body>
</html>
